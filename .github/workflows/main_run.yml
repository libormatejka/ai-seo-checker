name: Main Daily Run

on:
  schedule:
    - cron: '0 7 * * *'
  workflow_dispatch:

jobs:
  main-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Test Google Sheets connection
        env:
          GOOGLE_SHEETS_CREDENTIALS: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}
          SHEET_URL: ${{ secrets.SHEET_URL }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import json
          import sys
          
          print("=" * 60)
          print("TESTING GOOGLE SHEETS CREDENTIALS")
          print("=" * 60)
          
          # Zkontroluj credentials
          creds = os.getenv('GOOGLE_SHEETS_CREDENTIALS')
          print(f'\n1. Credentials present: {bool(creds)}')
          if creds:
              print(f'   Credentials length: {len(creds)} characters')
              print(f'   First 50 chars: {creds[:50]}...')
          else:
              print('   âŒ CREDENTIALS ARE MISSING!')
              sys.exit(1)
          
          # Zkus parsovat JSON
          print('\n2. Testing JSON parsing...')
          try:
              creds_dict = json.loads(creds)
              print('   âœ… JSON is valid')
              print(f'   Keys in JSON: {list(creds_dict.keys())}')
              
              # Zkontroluj dÅ¯leÅ¾itÃ© keys
              required_keys = ['type', 'project_id', 'private_key', 'client_email']
              for key in required_keys:
                  if key in creds_dict:
                      if key == 'private_key':
                          print(f'   âœ… {key}: present ({len(creds_dict[key])} chars)')
                      elif key == 'client_email':
                          print(f'   âœ… {key}: {creds_dict[key]}')
                      else:
                          print(f'   âœ… {key}: {creds_dict[key]}')
                  else:
                      print(f'   âŒ {key}: MISSING!')
                      
          except json.JSONDecodeError as e:
              print(f'   âŒ JSON parse error: {e}')
              print(f'   Error at position: {e.pos}')
              sys.exit(1)
          except Exception as e:
              print(f'   âŒ Unexpected error: {e}')
              sys.exit(1)
          
          # Zkontroluj URL
          print('\n3. Testing Sheet URL...')
          url = os.getenv('SHEET_URL')
          if url:
              print(f'   âœ… Sheet URL present')
              print(f'   URL: {url}')
              
              # Extrahuj Sheet ID
              import re
              match = re.search(r'/spreadsheets/d/([a-zA-Z0-9-_]+)', url)
              if match:
                  sheet_id = match.group(1)
                  print(f'   âœ… Sheet ID extracted: {sheet_id}')
              else:
                  print(f'   âŒ Cannot extract Sheet ID from URL')
          else:
              print('   âŒ SHEET_URL IS MISSING!')
              sys.exit(1)
          
          # Test connection
          print('\n4. Testing actual Google Sheets connection...')
          try:
              from google.oauth2.service_account import Credentials
              import gspread
              
              scopes = [
                  'https://www.googleapis.com/auth/spreadsheets',
                  'https://www.googleapis.com/auth/drive'
              ]
              
              creds_obj = Credentials.from_service_account_info(creds_dict, scopes=scopes)
              print('   âœ… Credentials object created')
              
              gc = gspread.authorize(creds_obj)
              print('   âœ… gspread authorized')
              
              wb = gc.open_by_url(url)
              print(f'   âœ… Successfully opened Sheet: "{wb.title}"')
              
              # List worksheets
              worksheets = wb.worksheets()
              print(f'   âœ… Found {len(worksheets)} worksheets:')
              for ws in worksheets:
                  print(f'      - {ws.title}')
              
          except gspread.exceptions.SpreadsheetNotFound:
              print('   âŒ ERROR: Spreadsheet not found!')
              print('   â†’ Make sure the Sheet URL is correct')
              print('   â†’ Make sure the Sheet exists')
              sys.exit(1)
          except gspread.exceptions.APIError as e:
              print(f'   âŒ API Error: {e}')
              if 'PERMISSION_DENIED' in str(e):
                  print('   â†’ Service account does not have access to this Sheet!')
                  print(f'   â†’ Share the Sheet with: {creds_dict.get("client_email")}')
              sys.exit(1)
          except Exception as e:
              print(f'   âŒ Connection error: {type(e).__name__}: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          
          print('\n' + '=' * 60)
          print('âœ… ALL TESTS PASSED!')
          print('=' * 60)
          PYTHON_SCRIPT
      
      - name: Run main analysis
        env:
          PERPLEXITY_KEY: ${{ secrets.PERPLEXITY_KEY }}
          GEMINI_KEY: ${{ secrets.GEMINI_KEY }}
          GOOGLE_SHEETS_CREDENTIALS: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}
          SHEET_URL: ${{ secrets.SHEET_URL }}
        run: |
          python scripts/main_run.py
      
      - name: Commit failed queries and logs
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/failed_queries.json
          git add logs/*.log || true
          git diff --staged --quiet || git commit -m "ðŸ“Š Main run [$(date +'%Y-%m-%d %H:%M')]"
          git push
      
      - name: Upload logs as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: main-run-logs-${{ github.run_number }}
          path: logs/
          retention-days: 7
      
      - name: Check failure rate
        run: |
          if [ -f "data/failed_queries.json" ]; then
            count=$(jq length data/failed_queries.json)
            echo "Failed queries: $count"
            if [ "$count" -gt 20 ]; then
              echo "::warning::High failure rate: $count failed queries"
            fi
          fi